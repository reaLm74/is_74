# is74

## Технологии

- Python
- FastAPI
- SQLAlchemy
- OpenCV
- PostgreSQL

<details> 
<summary> Поставленная задача </summary>

Тестовое задание на позицию Python Backend Developer

Описание

Платформа видеоаналитики – no-code платформа-конструктор, позволяющая собирать
сценарии видеоаналитики с использованием технологий искусственного интеллекта и
компьютерного зрения без написания кода. В рамках тестового задания необходимо
реализовать упрощенную версию одного из сервисов платформы - сервиса обработки
изображений.

Задание

Требуется реализовать REST API сервис, который принимает на вход изображения и
прогоняет их по различным пайплайнам обработки изображений. Сами пайплайны
должны конфигурироваться через базу данных. То есть в базе требуется фиксировать
сами пайплайны и шаги, которые необходимо проделать в рамках пайплайнов. При
этом, сами пайплайны динамичны и могут изменяться со временем.

В рамках тестового задания необходимо реализовать пайплайн детекции автомобиля.
Пайплайн состоит из следующих шагов:

- Обработка изображения
- Прогон обработанного изображения через модель машинного обучения
- Сохранение в БД информации, задетектирован ли на изображении автомобиль, а
  также координаты бокса автомобиля, если он задетектирован

Обработка изображения включает в себя следующие этапы:

- Преобразовать изображение в numpy-массив. Для этого потребуется
  воспользоваться библиотекой numpy и методом frombuffer
- Считать numpy-массив с помощью библиотеки opencv-python, метода imdecode
- Изменить размер изображения до размера 640x640. Можно реализовать с помощью
  библиотеки opencv-python, метода resize.
- Нормализовать изображение. Можно реализовать с помощью библиотеки
  opencv-python, метода normalize.
- Преобразовать обработанное изображение в base64-строку. Для этого изображение
  сначала нужно преобразовать в байты, а затем обработать библиотекой base64

Второй пункт требуется реализовать в виде отдельного микросервиса, который будет
имитировать работу модели машинного обучения. На вход сервис должен получать
обработанное изображение, после чего с шансом 50/50 выдавать либо пустой ответ,
либо заранее заготовленные координаты бокса автомобиля - прямоугольника, внутри
которого найден автомобиль. Стандартный формат координат
- [top_left_x, top_left_y, w, h, conf, label], где top_left_x - координата по
оси X верхней левой точки бокса, top_left_y - координата по оси Y верхней левой
точки бокса, w - ширина бокса (в пикселях), h - высота бокса (в пикселях), conf
- уверенность модели (от 0 до 1), label - класс модели - в данном случае это 1,
поскольку автомобиль найден.

Следует учесть, что в идеале сервис должен быть способен выдерживать достаточно
большую нагрузку - до нескольких тысяч запросов в минуту. Либо должно быть
понимание, как доработать сервис, чтобы он смог выдерживать такую нагрузку.

Требования

- Сервис обработки изображений должен быть написан на FastAPI
- В сервисе обработки изображений должен быть метод /process_image, который на
  вход принимает JPEG-изображение и id пайплайна. Сам метод прогоняет
  изображение по заданному пайплайну
- В качестве СУБД использовать Postgresql. Для работы с базой использовать
  sqlalchemy
- Использование Docker, сервис должен запускаться с помощью docker-compose. В
  том числе, через docker-compose должен запускаться postgresql

</details>

## Как запустить проект:

### Клонирование репозитория:

```sh
git clone https://github.com/realm74/is_74
```

<details> <summary> Шаблон наполнения .env </summary>

```
Example of filling a file .env:

DRIVER='postgresql+asyncpg'
USER='postgres'
PASSWORD='postgres'
HOST='localhost'
PORT='5432'
DB_NAME='postgres'

POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
POSTGRES_DB=postgres
```

</details>

### Запуск приложения в Docker

Собрать контейнер

```
docker-compose build
```

Запустить docker-compose.yaml

```
docker-compose up
```

Добавить pipeline_id=1 в БД

```
docker cp ./psql.sql postgres:/docker-entrypoint-initdb.d/dump.sql
docker exec -u postgres postgres psql postgres postgres -f docker-entrypoint-initdb.d/dump.sql
```

Проект запущен

```
http://127.0.0.1:8000/docs
```

Удалить контейнеры

```
docker-compose down
```

## Примеры

<details> 
<summary> Подробнее </summary>

Пример запроса

```
curl -X 'POST' \
  'http://127.0.0.1:8000/process_image?pipeline_id=1' \
  -H 'accept: application/json' \
  -H 'Content-Type: multipart/form-data' \
  -F 'image=@115.png;type=image/png'
```

Примеры ответов

```
{
  "detail": {
    "status": "Successful"
  }
}
```

```
{
  "detail": {
    "status": "Car not found in image"
  }
}
```

```
{
  "detail": {
    "status": "Not successful"
  }
}
```

</details>
